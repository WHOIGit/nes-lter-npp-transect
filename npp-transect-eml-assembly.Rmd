---
title: "npp-transect-eml-assembly"
author: "Kate Morkeski"
date: "3/3/2022"
output: html_document
---

## Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

# Load required packages

# two of the required packages are installed from GitHub
# uncomment these lines to update as needed
# library(remotes)
# remotes::install_github("EDIorg/EMLassemblyline")
# remotes::install_github("WHOIGit/ediutilities")

library(EMLassemblyline)
library(ediutilities)
library(here)
library(tidyverse)
library(readxl)
library(lubridate)
library(devtools)
library(EML)
library(maps)
library(xml2)
library(geosphere)
library(httr)
library(compareDF)

# Set path to root of project
here("nes-lter-npp-transect")

```

## Read in provided data

```{r}

# version1 August 2019-February 2020
# version2 July-October 2020

# identify version
discrete_filename <- "npp_discrete_version1"
integrated_filename <- "npp_integrated_version1"

#discrete_filename <- "npp_discrete_version2"
#integrated_filename <- "npp_integrated_version2"

npp_discrete <- read_csv(paste0(discrete_filename, '.csv'), show_col_types = FALSE) 
npp_integrated <- read_csv(paste0(integrated_filename, '.csv'), show_col_types = FALSE) 

```

## Provide summary statistics

```{r}



```

## Plot values to confirm flags and complete a visual inspection

```{r}



```

## Plot sampling locations and complete a visual geographic inspection

```{r}



```
## Create package data files if any changes to csvs

```{r}



```

## EML Assembly

# Read data table if needed
# identify date column for ediutilities package to generate temporal coverage
# Read the Excel metadata template and generate text templates used by EMLassemblyline


```{r}

excel_template <- 'npp-transect-info.xlsx'

sheet_to_tsv(excel_template, 'ColumnHeadersDiscrete', paste0('attributes_', discrete_filename, '.txt'))  

sheet_to_tsv(excel_template, 'ColumnHeadersIntegrated', paste0('attributes_', integrated_filename, '.txt'))

sheet_to_tsv(excel_template, 'CategoricalVariables', paste0('catvars_', discrete_filename, '.txt'))

sheet_to_tsv(excel_template, 'CategoricalVariables', paste0('catvars_', integrated_filename, '.txt'))

sheet_to_tsv(excel_template, 'Personnel', 'personnel.txt')

sheet_to_tsv(excel_template, 'Keywords', 'keywords.txt')

sheet_to_tsv(excel_template, 'CustomUnits', 'custom_units.txt')

```

Use templates in "template core metadata" step from EML assembly line

```{r}

EMLassemblyline::template_core_metadata(path=here(), license='CCBY')

```

Generate the package and insert the parent project node into the resulting EML

```{r}

 if (discrete_filename == "npp_discrete_version1") {pkg_id <- 'knb-lter-nes.16.1'} else if (discrete_filename == "npp_discrete_version2") {pkg_id <- 'knb-lter-nes.16.2'}
        

make_eml(here(),
         dataset.title='Size-fractionated net primary productivity (NPP) estimates based on 13C uptake during cruises along the Northeast U.S. Shelf Long Term Ecological Research (NES-LTER) Transect, ongoing since 2019', 
         data.table= c(paste0(discrete_filename, '.csv'), paste0(integrated_filename, '.csv')),  
         data.table.description= c('Discrete net primary productivity data', 'Integrated net primary productivity data'),
         data.table.name = c('Discrete NPP', 'Integrated NPP'),
         other.entity = c('raw_npp_data.csv','HOBO_data.zip'),
         other.entity.name = c('Raw NPP data table','Raw temperature data files'),
         other.entity.description = 'Raw data used to generate product data tables',
         temporal.coverage = temporal_coverage(append(npp_discrete$date_time_utc, npp_integrated$date_time_utc)),
         geographic.description = "NES-LTER",
         geographic.coordinates = geographic_coordinates(npp_discrete$latitude, npp_discrete$longitude),
         maintenance.description = "ongoing",
         user.id = "NES",
         user.domain = "LTER",
         package.id = pkg_id)
 
project_insert(pkg_id)

```
